<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>Historique des notes</title>
  <style>
    button.link {
      background: none;
      border: none;
      color: blue;
      text-decoration: underline;
      cursor: pointer;
      font-size: 1em;
      padding: 0;
    }
  </style>
</head>
<body>

  <p>
    Bienvenue <span sec:authentication="name"></span> !
    <!-- Logout en POST vers /auth/logout -->
    <form th:action="@{/auth/logout}" method="post" style="display:inline;">
      <button type="submit" class="link">Se déconnecter</button>
    </form>
  </p>

  <h1>
    Notes du patient
    <span th:text="${patient.firstName}"></span>
    <span th:text="${patient.lastName}"></span>
  </h1>

  <p><strong>Date de naissance :</strong>
    <span th:text="${patient.birthDate}">--</span>
  </p>
  <p><strong>Genre :</strong>
    <span th:text="${patient.gender}">--</span>
  </p>

  <h2>Historique médical</h2>
  <ul>
    <li th:each="note : ${notes}"
        th:text="${note.content}"></li>
  </ul>
  <p th:if="${#lists.isEmpty(notes)}">Aucune note pour ce patient.</p>

  <div sec:authorize="hasRole('PRATICIEN')">
    <h3>Ajouter une nouvelle note</h3>

    <!-- IMPORTANT : on passe par /ui/notes pour repasser par le Gateway -->
    <form th:action="@{/ui/notes}" method="post">

      <!-- Pas de champ CSRF : sécurité assurée par JWT -->

      <input type="hidden" name="patientId" th:value="${patient.id}" />

      <div>
        <textarea name="content"
                  placeholder="Nouvelle note..."
                  rows="3"
                  cols="40"
                  required></textarea>
      </div>
      <div>
        <button type="submit">Ajouter</button>
      </div>
    </form>
  </div>

  <br>
  <!-- Retour via /ui/patients pour repasser par le Gateway -->
  <a th:href="@{/ui/patients}">⬅ Retour à la liste des patients</a>

</body>
</html>
